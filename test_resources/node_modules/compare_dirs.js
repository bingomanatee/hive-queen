var _ = require('underscore');
var util = require('util');
var path = require('path');
var fs = require('fs');
var _DEBUG = false;
var Gate = require('gate');
var filecompare = require('filecompare');
var jsdiff = require('diff');

/* ************************************
 * 
 * ************************************ */

/* ******* CLOSURE ********* */

/* ********* EXPORTS ******** */

module.exports = function compare_dirs(a, b, t, cb, msg) {
	if (!msg) msg = '';

	function _r(a) {
		if (root) {
			return a.replace(root, '');
		} else {
			return a;
		}
	}

	if (_DEBUG) console.log("start comparing \n   %s \n   %s", _r(a), _r(b));
	var gate = Gate.create();
	var lg = gate.latch();

	gate.await(function () {
		if (_DEBUG) console.log('done comparing %s and %s', _r(a), _r(b));
		cb();
	});

	fs.readdir(a, function (err, a_contents) {
		if (err) throw err;
		fs.readdir(b, function (err, b_contents) {
			if (err) throw err;
			t.same(a_contents, b_contents, util.format(
				'directory %s files == directory %s files', _r(a), _r(b)) + (msg || ''));

			b_contents.forEach(function (b_file) {
				var a_path = path.resolve(a, b_file);
				var b_path = path.resolve(b, b_file);

				var gate2 = Gate.create();
				var la = gate2.latch();
				var lb = gate2.latch();
				var l2g = gate.latch();

				var as, bs;
				fs.stat(b_path, function (err, stat) {
					as = stat;
					la();
				});

				fs.stat(a_path, function (err, stat) {
					bs = stat;
					lb();
				});

				gate2.await(function () {
					t.ok(
						(as.isDirectory() == bs.isDirectory()) && (as.isFile() == bs.isFile()),
						msg + ': ' + _r(a_path) + ' is not the same type(file/dir) as ' + _r(b_path)
					);

					if (as.isDirectory() && bs.isDirectory()) {
						compare_dirs(a_path, b_path, t, gate.latch(), msg);
					} else if (as.isFile() && bs.isFile()) {
						var gl = gate.latch();
						filecompare(a_path, b_path, function (isEqual) {

							if (!isEqual) {
								console.log("\n file difference: ");
								var a = fs.readFileSync(a_path, 'utf8');
								var b = fs.readFileSync(b_path, 'utf8');

								var line_diff = jsdiff.diffLines(a, b);

								console.log('------- file diff ----------', a_path);
								console.log('diff: %s', util.inspect(line_diff));
								console.log('------- file A: %s ----------', a_path);
								console.log('------- file A: %s ----------', a_path);
								console.log(a);
								console.log("------- END FILE A: %s ----------", a_path);
								console.log('------- file B: %s ---------', b_path);
								console.log(b);
								console.log("------- END FILE B: %s ----------", b_path);
							}
							t.ok(isEqual, msg + ': ' + _r(a_path) + ' == ' + _r(b_path));

							gl();
						});
					}
					l2g();
				});
			});

			lg();
		})
	})
};